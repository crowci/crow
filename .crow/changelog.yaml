clone:
  git:
    image: docker.io/woodpeckerci/plugin-git:2.6.0
    settings:
      tags: true

when:
  event: [push, manual]
  branch: ${CI_REPO_DEFAULT_BRANCH}

steps:
  - name: 'Upcoming Changelog'
    environment:
      GITHUB_TOKEN:
        from_secret: ISSUE_TOKEN
    image: docker.io/thegeeklab/git-sv:1.0.9
    commands: |
      apk add -q --no-cache jq github-cli

      export RELEASE_NOTES=$(git sv rn)
      export ISSUE_NUMBER=$(gh issue list --json number --state open --label "changelog" | jq -r '.[] | .number')

      if [ -z "$ISSUE_NUMBER" ]; then
        gh issue create --title "Changelog for next version" --body "$RELEASE_NOTES"
      else
        gh issue edit $ISSUE_NUMBER --title "Changelog for next version" --body "$RELEASE_NOTES"
      fi
